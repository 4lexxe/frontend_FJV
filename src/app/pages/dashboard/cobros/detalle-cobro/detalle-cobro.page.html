<div class="detalle-cobro-container">
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-1">Detalle del Cobro</h2>
            <p class="text-muted">Información detallada del cobro y opciones de gestión</p>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-info btn-sm" (click)="refreshCobroManually()" [disabled]="isLoading">
              <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoading"></i> Actualizar
            </button>
            <button class="btn btn-outline-secondary" (click)="volver()">
              <i class="fas fa-arrow-left me-2"></i> Volver
            </button>
          </div>
        </div>

        <!-- Indicador de monitoreo en tiempo real -->
        @if (cobro && (cobro.estado === 'Pendiente' || cobro.estado === 'Vencido')) {
          <div class="alert" [ngClass]="isMonitoring ? 'alert-info' : 'alert-light'" role="alert">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="fas" [ngClass]="isMonitoring ? 'fa-eye text-info' : 'fa-eye-slash text-muted'" [class.fa-blink]="isMonitoring"></i>
                <span class="ms-2">
                  <strong>Monitoreo Automático:</strong>
                  {{ isMonitoring ? 'ACTIVO - El estado se actualiza cada 5 segundos' : 'INACTIVO - Actualización manual solamente' }}
                </span>
              </div>
              <div>
                @if (!isMonitoring) {
                  <button class="btn btn-outline-info btn-sm" (click)="startManualMonitoring()">
                    <i class="fas fa-play me-1"></i> Activar
                  </button>
                } @else {
                  <button class="btn btn-outline-secondary btn-sm" (click)="stopManualMonitoring()">
                    <i class="fas fa-stop me-1"></i> Detener
                  </button>
                }
              </div>
            </div>
          </div>
        }

        <!-- Estado de carga o error -->
        @if (isLoading) {
          <div class="card shadow-sm">
            <div class="card-body p-4 text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2">Cargando información del cobro...</p>
            </div>
          </div>
        } @else if (errorMessage) {
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i> {{errorMessage}}
          </div>
        } @else if (cobro) {
          <div class="row">
            <!-- Detalles del cobro -->
            <div class="col-lg-8 mb-4">
              <div class="card shadow-sm">
                <div class="card-header"
                     [ngClass]="{
                       'bg-success': cobro.estado === 'Pagado',
                       'bg-warning': cobro.estado === 'Pendiente',
                       'bg-danger': cobro.estado === 'Vencido',
                       'bg-secondary': cobro.estado === 'Anulado'
                     }"
                     class="text-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                      <i class="fas fa-file-invoice-dollar me-2"></i>
                      Cobro #{{cobro.idCobro}}
                      @if (isMonitoring && (cobro.estado === 'Pendiente' || cobro.estado === 'Vencido')) {
                        <span class="pulse-dot ms-2" title="Monitoreo activo"></span>
                      }
                    </h5>
                    <span class="badge"
                          [ngClass]="{
                            'bg-light text-success': cobro.estado === 'Pagado',
                            'bg-light text-warning': cobro.estado === 'Pendiente',
                            'bg-light text-danger': cobro.estado === 'Vencido',
                            'bg-light text-secondary': cobro.estado === 'Anulado'
                          }">
                      {{cobro.estado}}
                    </span>
                  </div>
                </div>
                <div class="card-body p-4">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <h6 class="text-muted mb-1">Club</h6>
                      <p class="mb-0 fw-bold">{{cobro.club?.nombre || 'No especificado'}}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                      <h6 class="text-muted mb-1">Monto</h6>
                      <p class="mb-0 fs-4 fw-bold text-success">{{ formatCurrency(cobro.monto) }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                      <h6 class="text-muted mb-1">Fecha de Emisión</h6>
                      <p class="mb-0">{{cobro.fechaCobro | date:'dd/MM/yyyy'}}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                      <h6 class="text-muted mb-1">Fecha de Vencimiento</h6>
                      <p class="mb-0">{{cobro.fechaVencimiento | date:'dd/MM/yyyy'}}</p>
                    </div>
                    <div class="col-md-12 mb-3">
                      <h6 class="text-muted mb-1">Tipo de Comprobante</h6>
                      <p class="mb-0">{{cobro.tipoComprobante}}</p>
                    </div>
                    <div class="col-md-12">
                      <h6 class="text-muted mb-1">Concepto</h6>
                      <p class="mb-0">{{cobro.concepto}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enlaces Públicos de Pago -->
            <div class="col-lg-8 mb-4">
              <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                      <i class="fas fa-link me-2"></i> Enlaces Públicos de Pago
                    </h5>
                    <button class="btn btn-light btn-sm"
                            (click)="generatePublicPaymentLink()"
                            [disabled]="isGeneratingLink || cobro.estado === 'Pagado' || cobro.estado === 'Anulado'">
                      <i class="fas fa-plus me-1" [class.fa-spin]="isGeneratingLink"></i>
                      {{isGeneratingLink ? 'Generando...' : 'Nuevo Enlace'}}
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  @if (hasNoLinks()) {
                    <div class="text-center py-4">
                      <i class="fas fa-link fa-3x text-muted mb-3"></i>
                      <h6 class="text-muted">No hay enlaces públicos creados</h6>
                      <p class="text-muted mb-3">Los enlaces públicos permiten que cualquier persona pueda pagar este cobro sin necesidad de autenticación.</p>
                      @if (cobro.estado === 'Pendiente' || cobro.estado === 'Vencido') {
                        <button class="btn btn-primary" (click)="generatePublicPaymentLink()" [disabled]="isGeneratingLink">
                          <i class="fas fa-plus me-2"></i> Crear Primer Enlace
                        </button>
                      }
                    </div>
                  }

                  @if (isValidLinksArray()) {
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Enlace</th>
                            <th>Estado</th>
                            <th>Accesos</th>
                            <th>Creado</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (link of publicPaymentLinks; track link.id) {
                            <tr>
                              <td>
                                <div class="d-flex align-items-center">
                                  <code class="me-2">{{publicPaymentService.buildPublicPaymentUrl(link.slug)}}</code>
                                  <button class="btn btn-outline-secondary btn-sm"
                                          (click)="copyPublicLinkToClipboard(publicPaymentService.buildPublicPaymentUrl(link.slug))"
                                          title="Copiar enlace">
                                    <i class="fas fa-copy"></i>
                                  </button>
                                </div>
                              </td>
                              <td>
                                <span class="badge" [ngClass]="link.isActive ? 'bg-success' : 'bg-secondary'">
                                  <i class="fas" [ngClass]="link.isActive ? 'fa-check' : 'fa-pause'"></i>
                                  {{link.isActive ? 'Activo' : 'Inactivo'}}
                                </span>
                              </td>
                              <td>
                                <span class="badge bg-info">
                                  <i class="fas fa-eye me-1"></i>
                                  {{link.accessCount}}
                                </span>
                              </td>
                              <td>
                                <small>{{link.createdAt | date:'dd/MM/yyyy HH:mm'}}</small>
                              </td>
                              <td>
                                <div class="btn-group btn-group-sm">
                                  <button class="btn btn-outline-primary"
                                          (click)="togglePublicLink(link)"
                                          title="{{link.isActive ? 'Desactivar' : 'Activar'}}">
                                    <i class="fas" [ngClass]="link.isActive ? 'fa-pause' : 'fa-play'"></i>
                                  </button>
                                  <button class="btn btn-outline-info"
                                          (click)="sharePublicLink(publicPaymentService.buildPublicPaymentUrl(link.slug))"
                                          title="Compartir">
                                    <i class="fas fa-share-alt"></i>
                                  </button>
                                  <button class="btn btn-outline-danger"
                                          (click)="deletePublicLink(link)"
                                          title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                  </button>
                                </div>
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                </div>
              </div>
            </div>

            <!-- Acciones -->
            <div class="col-lg-4 mb-4">
              <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                  <h5 class="mb-0"><i class="fas fa-cog me-2"></i> Acciones</h5>
                </div>
                <div class="card-body p-4">
                  <div class="d-grid gap-2">
                    <!-- Botón de Pagar con Mercado Pago -->
                    @if (canPay()) {
                      <button class="btn btn-mercadopago" (click)="openPaymentModal()">
                        <i class="fas fa-credit-card me-2"></i>
                        Pagar con Mercado Pago
                        @if (isMonitoring) {
                          <small class="d-block mt-1 opacity-75">Monitoreo automático activo</small>
                        }
                      </button>
                    }

                    <!-- Botón de Marcar como Pagado (Admin) -->
                    @if (cobro.estado === 'Pendiente') {
                      <button class="btn btn-success" (click)="marcarComoPagado()">
                        <i class="fas fa-check-circle me-2"></i> Marcar como Pagado
                      </button>
                    } @else if (cobro.estado === 'Pagado') {
                      <button class="btn btn-success" disabled>
                        <i class="fas fa-check-circle me-2"></i> Cobro Pagado
                      </button>
                    }

                    <a [routerLink]="['/dashboard/cobros/factura', cobro.idCobro]" class="btn btn-primary">
                      <i class="fas fa-file-invoice me-2"></i> Ver/Generar Comprobante
                    </a>

                    <button class="btn btn-outline-info">
                      <i class="fas fa-envelope me-2"></i> Enviar por Email
                    </button>
                  </div>
                </div>
              </div>

              <!-- Información adicional -->
              <div class="card shadow-sm mt-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Información adicional</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <small class="text-muted">Estado del cobro:</small>
                    <div class="mt-1">
                      @if (cobro.estado === 'Pagado') {
                        <span class="badge bg-success py-2 px-3">
                          <i class="fas fa-check-circle me-1"></i> Pagado
                        </span>
                      } @else if (cobro.estado === 'Pendiente') {
                        <span class="badge bg-warning py-2 px-3">
                          <i class="fas fa-clock me-1"></i> Pendiente
                          @if (isMonitoring) {
                            <small class="pulse-dot ms-1"></small>
                          }
                        </span>
                      } @else if (cobro.estado === 'Vencido') {
                        <span class="badge bg-danger py-2 px-3">
                          <i class="fas fa-exclamation-circle me-1"></i> Vencido
                          @if (isMonitoring) {
                            <small class="pulse-dot ms-1"></small>
                          }
                        </span>
                      } @else {
                        <span class="badge bg-secondary py-2 px-3">
                          <i class="fas fa-ban me-1"></i> Anulado
                        </span>
                      }
                    </div>
                  </div>

                  <!-- Información de Mercado Pago -->
                  @if (canPay()) {
                    <div class="mb-3">
                      <small class="text-muted">Medios de pago disponibles:</small>
                      <div class="mt-1">
                        <div class="payment-methods">
                          <span class="badge bg-primary me-1 mb-1">
                            <i class="fas fa-credit-card me-1"></i> Tarjetas
                          </span>
                          <span class="badge bg-info me-1 mb-1">
                            <i class="fas fa-university me-1"></i> Transferencia
                          </span>
                          <span class="badge bg-success me-1 mb-1">
                            <i class="fas fa-money-bill me-1"></i> Efectivo
                          </span>
                        </div>
                      </div>
                    </div>
                  }

                  <!-- Información de monitoreo -->
                  @if (isMonitoring && (cobro.estado === 'Pendiente' || cobro.estado === 'Vencido')) {
                    <div class="mb-3">
                      <small class="text-muted">Actualización automática:</small>
                      <div class="mt-1">
                        <small class="text-info">
                          <i class="fas fa-info-circle me-1"></i>
                          El estado se verifica cada 5 segundos automáticamente
                        </small>
                      </div>
                    </div>
                  }

                  <div>
                    <small class="text-muted">Validez del comprobante:</small>
                    <p class="mb-0 mt-1">Este documento tiene validez legal como comprobante de cobro.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Modal de Pago con Mercado Pago -->
  <app-pago-cobro
    *ngIf="cobro"
    [cobro]="cobro"
    [showModal]="showPaymentModal"
    (closeModal)="closePaymentModal()"
    (paymentInitiated)="onPaymentInitiated()">
  </app-pago-cobro>

  <!-- Modal para mostrar enlace público generado -->
  @if (showPublicLinkModal) {
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog" aria-modal="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-link me-2"></i> Enlace Público Generado
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="closePublicLinkModal()"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              <strong>¡Enlace creado exitosamente!</strong>
              Ahora cualquier persona puede acceder a este enlace para realizar el pago.
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">URL del enlace público:</label>
              <div class="input-group">
                <input type="text"
                       class="form-control"
                       [value]="generatedPublicUrl"
                       readonly>
                <button class="btn btn-outline-secondary"
                        (click)="copyPublicLinkToClipboard(generatedPublicUrl)"
                        title="Copiar enlace">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-outline-primary"
                        (click)="sharePublicLink(generatedPublicUrl)"
                        title="Compartir enlace">
                  <i class="fas fa-share-alt"></i>
                </button>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-info-circle me-2"></i> Características del enlace:</h6>
                <ul class="list-unstyled">
                  <li><i class="fas fa-check text-success me-2"></i> No requiere autenticación</li>
                  <li><i class="fas fa-check text-success me-2"></i> URL amigable basada en el concepto</li>
                  <li><i class="fas fa-check text-success me-2"></i> Puede activarse/desactivarse</li>
                  <li><i class="fas fa-check text-success me-2"></i> Contador de accesos incluido</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-share-alt me-2"></i> Formas de compartir:</h6>
                <ul class="list-unstyled">
                  <li><i class="fas fa-envelope text-primary me-2"></i> Por email</li>
                  <li><i class="fas fa-mobile-alt text-success me-2"></i> Por WhatsApp</li>
                  <li><i class="fas fa-link text-info me-2"></i> En redes sociales</li>
                  <li><i class="fas fa-qrcode text-secondary me-2"></i> Código QR (próximamente)</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closePublicLinkModal()">
              Cerrar
            </button>
            <button type="button"
                    class="btn btn-primary"
                    (click)="copyPublicLinkToClipboard(generatedPublicUrl)">
              <i class="fas fa-copy me-2"></i> Copiar Enlace
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show"></div>
  }
</div>
